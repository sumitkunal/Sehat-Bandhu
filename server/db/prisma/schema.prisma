generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}



//
// ───────────────────────────────────────────
// USERS
// ───────────────────────────────────────────
//

model User {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  email      String    @unique
  phone      String?
  password   String
  role       Role
  status     Status
  lastLogin  DateTime?

  profile    Profile?
  doctor     Doctor?    @relation("UserDoctor")
  patient    Patient?   @relation("UserPatient")

  notifications Notification[]

  @@index([role])
  @@index([phone])
}

//
// ───────────────────────────────────────────
// PATIENT
// ───────────────────────────────────────────
//

model Patient {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  userId    String  @db.ObjectId @unique
  user      User    @relation("UserPatient", fields: [userId], references: [id])

  // Optional medical info
  allergies        String[]
  chronicDiseases  String[]
  bloodGroup       String?

  age              Int?
  symptoms         String[]
  temperature      Float?
  pulse            Int?
  bloodPressure    String?
  breathingRate    Int?

  appointments     Appointment[]
}

//
// ───────────────────────────────────────────
// PROFILE
// ───────────────────────────────────────────
//

model Profile {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId @unique
  user         User     @relation(fields: [userId], references: [id])

  name         String
  dob          DateTime?
  gender       String?
  address      Address?
  geo          Geo?

  avatar       Bytes?
  avatarType   String?

  @@index([address.state, address.district])
}

//
// ───────────────────────────────────────────
// DOCTOR
// ───────────────────────────────────────────
//

model Doctor {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  userId           String   @db.ObjectId @unique
  user             User     @relation("UserDoctor", fields: [userId], references: [id])

  regNo            String
  specialties      String[]
  clinicName       String?
  yearOfExperience Int?
  language         String[]
  about            String?

  verification     Verification?

  appointments     Appointment[]
  Availability     Availability[]
}

//
// ───────────────────────────────────────────
// APPOINTMENTS
// ───────────────────────────────────────────
//

model Appointment {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  
  doctorId      String   @db.ObjectId
  patientId     String   @db.ObjectId

  doctor        Doctor   @relation(fields: [doctorId], references: [id])
  patient       Patient  @relation(fields: [patientId], references: [id])

  date          String
  time          String

  age               Int
  gender            String
  symptoms          String
  allergies         String[]
  chronicDiseases   String[]
  temperature       Float?
  pulse             Int?
  bloodPressure     String?
  breathingRate     Int?

  status            AppointmentStatus
  reschedules       Reschedule[] @relation("AppointmentReschedule")
}


//
// ───────────────────────────────────────────
// DOCTOR AVAILABILITY
// ───────────────────────────────────────────
//

model Availability {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId

  doctorId  String   @db.ObjectId
  doctor    Doctor   @relation(fields: [doctorId], references: [id])

  date      String
  slots     String[]

  @@unique([doctorId, date], name: "doctorId_date")
}

//
// ───────────────────────────────────────────
// RESCHEDULE HISTORY
// ───────────────────────────────────────────
//

model Reschedule {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId

  appointmentId String    @db.ObjectId

  appointment   Appointment @relation("AppointmentReschedule", fields: [appointmentId], references: [id])

  oldDate       DateTime?
  newDate       DateTime?
  oldSlot       String?
  newSlot       String?

  changedAt     DateTime  @default(now())
}


//
// ───────────────────────────────────────────
// NOTIFICATIONS
// ───────────────────────────────────────────
//

model Notification {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  userId     String    @db.ObjectId
  user       User      @relation(fields: [userId], references: [id])

  title      String
  message    String
  read       Boolean   @default(false)
  createdAt  DateTime  @default(now())
}

//
// ───────────────────────────────────────────
// ENUMS
// ───────────────────────────────────────────
//

enum Role {
  patient
  doctor
  admin
}

enum Status {
  active
  pending
  blocked
}

enum AppointmentStatus {
  upcoming
  completed
  cancelled
  rescheduled
}

enum PaymentStatus {
  pending
  paid
  refunded
}

//
// ───────────────────────────────────────────
// EMBEDDED TYPES
// ───────────────────────────────────────────
//

type Verification {
  status    Status
  documents String[]
}

type Address {
  line      String?
  district  String?
  state     String?
  pincode   String?
}

type Geo {
  lat Float?
  lng Float?
}
